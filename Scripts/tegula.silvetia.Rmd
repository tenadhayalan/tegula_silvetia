---
title: "tegula.silvetia"
author: "Tena Dhayalan"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    toc: yes
    toc_float:
      collapsed: true
---
  
```{r,echo=FALSE, message=FALSE}
library(dplyr)
library(broom)
library(purrr)
library(lubridate)
library(tidyverse)
library(nlstools)
library(here)
library(stringr)
library(lmerTest)
library(emmeans)
library(lme4)
library(knitr)
require(kableExtra)
library(tidyverse)
library(car)
options(knitr.table.format = "html")
library(maps)
library(mapproj)
library(mapdata)
library(effectsize)
library(ggtext)
library(patchwork)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,    # Show warnings
  message = FALSE,    # Show messages
  error = FALSE       # Show errors
)
```

```{r, echo = FALSE}
#Load datasets
calc <- read_csv(here("Data", "TA", "NEC.csv")) # calcification both months
shellcalc <- read_csv(here("Data", "TA", "shell_NEC.csv"))
aprilpH <- read_csv(here("Data","pH_temp","ph_temp_final_cut.csv")) # april pH
aprilcarb <- read_csv(here("Data","pH_temp","april_carb.csv")) # april background co2 parameters
aprilTeg <- read_csv(here("Data","growth","tegula_initial_april.csv")) # april tegula
maypH <- read_csv(here("Data","pH_temp","ph_temp_may_final.csv")) # may pH
maycarb <- read_csv(here("Data", "pH_temp", "may_carb.csv")) # may background co2 parameters
mayTeg <- read_csv(here("Data","growth","tegula_initial_may.csv")) # may tegula
Sample.Info <- read_csv(here("Data","PR_2024","Metadata_combined.csv")) # respo metadata both months
respo_dry_clean <- read.csv(here("Data", "PR_2024","PR_final_normalized_dry_clean.csv")) # respo both months
cn <- read.csv(here("Data", "CN ratio","cn_exp1.csv")) # C:N rockweed data
cuti <- read.csv(here("Data","pH_temp","cuti_daily.csv")) # coastal upwelling index
beuti <- read.csv(here("Data","pH_temp","beuti_daily.csv")) #biologically effective upwelling index
temp <- read.csv(here("Data","field","san_pedro_temp_buoy.csv")) #https://data.caloos.org/#metadata/103471/station/data
rwfield <- read.csv(here("Data","field","rockweed_density.csv")) # rockweed density from quadrats
rwsizefield <- read.csv(here("Data","field","rockweed_size.csv")) # rockweed size from quadrats
tegfield <- read.csv(here("Data","field","rw_eiseni.csv")) # tegula densities from quadrats
tegsizefield <- read.csv(here("Data","field","eiseni_size.csv")) # tegula size from quadrats
```

### adding pH data
```{r}

# adding pH to metadata
Sample.Info.April <-
  Sample.Info %>%
  filter(experiment == "a") %>%
  left_join(
    aggregate(cbind(pH,TempInSitu) ~ tank, data = aprilpH, FUN = mean) %>%
    mutate(tank = as.character(tank)), 
    by = "tank") %>%
  rename(temp = TempInSitu)

Sample.Info.May <-
  Sample.Info %>%
  filter(experiment == "b") %>%
  left_join(
    aggregate(cbind(pH,TempInSitu) ~ tank, data = maypH, FUN = mean) %>%
    mutate(tank = as.character(tank)), 
    by = "tank") %>%
  rename(temp = TempInSitu)

# combine april and may
Sample.Info.New <- bind_rows(Sample.Info.April,Sample.Info.May)

# assigning factors
Sample.Info.New <- Sample.Info.New %>%
  mutate(BLANK = as.factor(BLANK)) %>%
  mutate(ID = as.factor(ID)) %>%
  mutate(dry_weight = as.numeric(dry_weight))

```

## pH and temp graphs
```{r}
aprilpH <- aprilpH %>%
  mutate(experiment = "Early Spring") # assigning experimental label as Early Spring
maypH <- maypH %>%
  mutate(experiment = "Late Spring") # assigning experimental label as Late Spring

AllpHData <- bind_rows(aprilpH, maypH) #bind together

# temperature graph
AllpHData %>%
  ggplot(aes(x=as.factor(expected_temp), y= TempInSitu, 
             group = interaction(expected_temp,experiment), color = experiment))+
  geom_boxplot(width = 0.5, outlier.alpha = 0.1)+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  theme_bw()+
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 16)) +
  labs(x = expression(paste("Target temperature (",degree,"C)")), 
       y = expression(paste("Average tank temperature (",degree,"C)")), 
       color = "Experiment" )

# pH graph
AllpHData %>%
  ggplot(aes(x=expected_pH, y= pH, gro.up = interaction(expected_pH,experiment), color = experiment))+
  geom_boxplot(width=0.1, outlier.alpha = 0.2)+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  theme_bw()+
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 16)) +
  labs(x = expression(Target~pH[T]), y = expression(Average~tank~pH[T]), color = "Experiment")
```
## carb parameters
```{r}
aprilcarb <- aprilcarb %>%
  mutate(experiment = "Early spring")%>% # add label for experiment
  mutate(SampleID = as.character(SampleID))

maycarb <- maycarb %>%
  mutate(experiment = "Late spring") # add label for experiment

carb <- bind_rows(aprilcarb, maycarb) # combine all

# calculate means and sds for each column
carb_summary <- carb %>%
  group_by(experiment, SampleID) %>%
  summarise(
    across(where(is.numeric),
           list(mean = ~mean(.x, na.rm = TRUE),
                sd = ~sd(.x, na.rm = TRUE)),
           .names = "{.col}_{.fn}") 
  )

# reformat so mean and sd are in the same column
carb_summary <- carb_summary %>%
  rowwise() %>%
  mutate(
    across(
      ends_with("_mean"),
      ~ {
        base <- sub("_mean$", "", cur_column())
        mean_val <- .x
        sd_val <- get(paste0(base, "_sd"))
        sprintf("%.2f Â± %.2f", mean_val, sd_val)
      },
      .names = "{.col}_formatted"
    )
  ) %>%
  ungroup() %>%
  dplyr::select(SampleID, experiment, ends_with("_formatted"))

write.csv(carb_summary, here("Data/pH_temp/carb_summary.csv"))
```

# field
```{r}
states<-map_data("state") #all state coordinates
ca_data <- states %>%
  filter(region == "california") #just filter out california

ggplot()+
  geom_polygon(data = ca_data,
               aes(x=long, y=lat, group = group), color = "black")+
  geom_point(aes(x = -118.294363, y = 33.704647), color= "blue", size = 5)+
  coord_map()+
  theme_void()
```


## field temp
```{r}
temp %>%
  ggplot(aes(x = as.factor(date), y = sea_water_temperature)) +
  geom_smooth(aes(x = date, y = sea_water_temperature),method = "loess", color = "salmon4", size = 1, se = TRUE)+
  geom_point(aes(x = date, y = sea_water_temperature), color = "salmon4", alpha = 0.1) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18),
    legend.position = "none") +
    labs(x = expression(Date),
    y = expression(paste("Temperature ",degree,"C"))
  ) 

```

# Upwelling Indices

## BEUTI
```{r, echo=FALSE}
beuti <- beuti %>%
  filter(year== 2024, month %in% 3:6) # dplyr::select only data from March to May 2024

beuti <- beuti %>%
  mutate(date = make_date(year, month, day)) # make a column of date to combine year, month, and day

beuti %>%
  ggplot(aes(x = as.factor(date), y = X34N)) +
  geom_smooth(aes(x = date, y = X34N),method = "loess", color = "salmon4", size = 1)+
  geom_point(aes(x = date, y = X34N), color = "salmon4", alpha = 0.2) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18),
    legend.position = "none") +
    labs(x = expression(Date),
    y = paste("Biologically Effective Upwelling \nTransport Index")
  ) 
```

# Field surveys

## rockweed
```{r}
rwfield <- rwfield %>%
  mutate(rockweed_density_m = rockweed_density * 4)

rwfield %>%
  ggplot(aes(x = 0, y=rockweed_density_m)) + 
    geom_dotplot(binaxis='y', stackdir='center', alpha = 0.1)+
    theme_bw()+
    stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), geom="pointrange", color="black", size = 1)+
    labs(y = expression(paste("Rockweed density m" ^ "-2")))+
    theme(axis.title = element_text(size = 22), axis.text = element_text(size = 18), 
          axis.text.x = element_blank(), 
          axis.title.x = element_blank())
```

## tegula

### tegula density
```{r}
tegfield <- tegfield %>%
  mutate(teg_density_m = total...eiseni * 4)

tegfield %>%
  ggplot(aes(x = 0, y = teg_density_m)) + 
    geom_dotplot(binaxis='y', stackdir='center', alpha = 0.1)+
    theme_bw()+
    stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), geom="pointrange", color="black", size = 1)+
    labs(y = expression(paste("Tegula density m" ^ "-2")))+
    theme(axis.title = element_text(size = 22), axis.text = element_text(size = 18), 
          axis.text.x = element_blank(), 
          axis.title.x = element_blank())
```

### tegula size
```{r}
# shell length

# define bin breaks
breaks <- seq(6, 18, by = 2)

tegshelllengthplot <-
ggplot(tegsizefield, aes(x = shell_length)) +
  geom_histogram(breaks = breaks, fill = "peachpuff3", color = "white") +
  scale_x_continuous(
    breaks = head(breaks, -1) + diff(breaks)/2,  # position labels at bin centers
    labels = paste(head(breaks, -1), "-", tail(breaks, -1))  # show bin ranges
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 15),
    axis.title = element_text(size = 18),
    plot.title = element_text(size = 15)
  ) +
  labs(x = "Shell length (mm)", y = "Observations")

# shell width

# define bin breaks
breaks <- seq(9, 21, by = 2)

tegshellwidthplot <-
ggplot(tegsizefield, aes(x = shell_width)) +
  geom_histogram(breaks = breaks, fill = "peachpuff3", color = "white") +
  scale_x_continuous(
    breaks = head(breaks, -1) + diff(breaks)/2,  # position labels at bin centers
    labels = paste(head(breaks, -1), "-", tail(breaks, -1))  # show bin ranges
  ) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 15),
    axis.title = element_text(size = 18),
    plot.title = element_text(size = 15)
  ) +
  labs(x = "Shell width (mm)", y = "Observations")

tegshelllengthplot + tegshellwidthplot + plot_layout(axes = "collect") # put plots together

ggsave("tegula field.png", path=here("Output"), width = 12, height = 6) # save to output folder

# determine range actually collected
allTeg <- bind_rows(aprilTeg, mayTeg) %>%
  filter(!is.na(shell_length2)) # get rid of extra snails not placed in tanks

summary(allTeg)
```

# Tegula

### separating respo dataset
```{r, echo=FALSE}
# merging tegula respo data
tegrespodry <- respo_dry_clean %>%
  filter(Species == "Tegula") %>% # filter out rockweeds
  mutate(ID = as.factor(ID))

Teg.Sample.Info.New <- Sample.Info.New %>%
  filter(Species == "Tegula")

Teg.Sample.Info.New.pH <- Teg.Sample.Info.New[, c("ID", "block", "pH", "Date")]

tegrespodry <- merge(tegrespodry, Teg.Sample.Info.New.pH, by = c("ID", "block"), all.x = TRUE)

tegrespodry$initial_wet_weight <- as.numeric(tegrespodry$initial_wet_weight) # making a number
tegrespodry$temp_treatment <- as.factor(tegrespodry$temp_treatment) # making temp a factor

```

### Wet weight to dry weight regression, don't think I used this
```{r eval = FALSE, echo = FALSE}
# add shell weight to dry weight
tegrespodry$dry_weight_with_shell <- tegrespodry$dry_weight + tegrespodry$dry_shell_weight

# regression testing wet weight to predict dry weight 
tegweightadj <- lm((dry_weight+dry_shell_weight) ~ wet_weight, data = tegrespodry)

# print results
summary(tegweightadj) #r^2 = 0.94

# visualize
ggplot(tegrespodry, aes(x = wet_weight, y = dry_weight_with_shell)) +
  geom_point() +  # Scatter plot
  geom_smooth(method = "lm", se = TRUE, color = "blue") +  # Regression line
  labs(title = "Wet weight as a predictor of dry weight for Tegula", x = "wet weight (g)", y = "dry weight (g)")

#looks like there might be outliers...

# extract residuals and influence measures
residuals <- resid(tegweightadj)
std_residuals <- rstandard(tegweightadj)
cooksd <- cooks.distance(tegweightadj)

# identify outliers (st residuals > 2 OR high cook's d)
outliers <- which(abs(std_residuals) > 2 | cooksd > (4 / nrow(tegrespodry)))

# print
tegrespodry[outliers, ]

# remove outliers
tegrespodry_clean <- tegrespodry[-outliers, ]

# model without outliers
tegweightadj_clean <- lm((dry_weight+dry_shell_weight) ~ wet_weight, data = tegrespodry_clean)

# clean model summary
summary(tegweightadj_clean) #r^2 = 0.99

# visualize, maybe this fig would go in the supplement?
ggplot(tegrespodry_clean, aes(x = wet_weight, y = dry_weight+dry_shell_weight)) +
  geom_point() +  # Scatter plot
  geom_smooth(method = "lm", se = TRUE, color = "blue") +  # Regression line
  labs(title = "Wet weight as a predictor of dry weight for Tegula", x = "Wet weight (g)", y = "Dry weight (g)")

## make predictions for initial data

# make initial data use the same name expected by the model
new_data <- data.frame(wet_weight = tegrespodry_clean$initial_wet_weight)  # rename initial_wet_weight to wet_weight

# make predictions
tegrespodry_clean$predicted_initial_dry_weight <- predict(tegweightadj_clean, newdata = new_data)

# get rid of shell weight
tegrespodry_clean$predicted_initial_dry_weight_no_shell <- tegrespodry_clean$predicted_initial_dry_weight - tegrespodry_clean$dry_shell_weight
```
## Growth

### Change in mass
```{r}
#tegrespodry$end_date <- as.Date(tegrespodry$Date, format = "%Y%m%d")
#tegrespodry$start_date <- as.Date("2025-02-17")

# calculate growth rate (change in wet weight over 28 days)
tegrespodry$growth_rate <- (tegrespodry$wet_weight - tegrespodry$initial_wet_weight) / 28 #g/d/individual
growth_model <- lm(growth_rate ~ pH + temp_treatment, data = tegrespodry)
summary(growth_model)
tegrespodry %>%
  ggplot(aes(x=pH, y=growth_rate, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Growth~Rate))

#outlier
z_scores <- scale(tegrespodry$growth_rate)

# Identify outliers (absolute z-score greater than 3)
outliers <- tegrespodry[abs(z_scores) > 3, ] ## check 61 on data sheet
```

### Shell Growth
```{r}
## April experiment
# calculate shell growth as final - initial / initial
aprilTeg <- aprilTeg %>%
  filter(!is.na(shell_length_mm) & shell_length_mm != 0) %>%  # remove NAs
  mutate(shell_length_growth = (shell_length2 - shell_length_mm) / shell_length_mm)

# model against ph and temp
shell_length_model <- lm(shell_length_growth ~ pH * factor(temp), data = aprilTeg)
anova(shell_length_model) # pH significant

# model with averages

# calculate averages
aprilTeg_avg <- aprilTeg %>%
  group_by(pH, temp) %>%  # group by temp and pH
  summarize(
    avg_lgrowth_rate = mean(shell_length_growth, na.rm = TRUE)  # calculate mean growth rate
  )

# average model
april_lgrowth_model <- lm(avg_lgrowth_rate ~ pH * factor(temp), data = aprilTeg_avg)
anova(april_lgrowth_model) # pH significant

# visualize
aprilTeg %>%  
  filter(!is.na(temp)) %>% 
  ggplot(aes(x=pH, y=shell_length_growth, color = as.factor(temp)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(April~Shell~Length~Growth))

# calculate change in shell width
aprilTeg <- aprilTeg %>%
  filter(!is.na(shell_width_mm) & shell_width_mm != 0) %>%  # remove NAs
  mutate(shell_width_growth = (shell_width2 - shell_width_mm) / shell_width_mm)

# calculate averages 
aprilTeg_avg <- aprilTeg %>%
  group_by(pH, temp) %>%  # group by temp and pH
  summarize(
    avg_wgrowth_rate = mean(shell_width_growth, na.rm = TRUE)  # calculate mean growth rate
  )

# model against ph and temp
shell_width_model <- lm(shell_width_growth ~ pH * factor(temp), data = aprilTeg)
anova(shell_width_model) # pH significant

# avg model
april_wgrowth_model <- lm(avg_wgrowth_rate ~ pH * factor(temp), data = aprilTeg_avg)
summary(april_wgrowth_model) # not significant

#visualize
aprilTeg %>%
  filter(!is.na(temp)) %>% 
  ggplot(aes(x=pH, y=shell_width_growth, color = as.factor(temp)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(April~Shell~Width~Growth))

## May experiment
# calculate shell growth as final - initial / initial
mayTeg <- mayTeg %>%
  filter(!is.na(shell_length_mm) & shell_length_mm != 0) %>%  # remove NAs
  mutate(shell_length_growth = (shell_length2 - shell_length_mm) / shell_length_mm)

# model against ph and temp
shell_length_model <- lm(shell_length_growth ~ pH * temp, data = mayTeg)
anova(shell_length_model) # nothing significant

# model with averages

# calculate averages
mayTeg_avg <- mayTeg %>%
  group_by(pH, temp) %>%  # group by temp and pH
  summarize(
    avg_lgrowth_rate = mean(shell_length_growth, na.rm = TRUE)  # calculate mean growth rate
  )

# average model
may_lgrowth_model <- lm(avg_lgrowth_rate ~ pH * factor(temp), data = mayTeg_avg)
anova(may_lgrowth_model) # not significant

# visualize
mayTeg %>%  
  filter(!is.na(temp)) %>% 
  ggplot(aes(x=pH, y=shell_length_growth, color = as.factor(temp)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(May~Shell~Length~Growth))

# calculate change in shell width
mayTeg <- mayTeg %>%
  filter(!is.na(shell_width_mm) & shell_width_mm != 0) %>%  # remove NAs
  mutate(shell_width_growth = (shell_width2 - shell_width_mm) / shell_width_mm)

# calculate averages 
mayTeg_avg <- mayTeg %>%
  group_by(pH, temp) %>%  # group by temp and pH
  summarize(
    avg_wgrowth_rate = mean(shell_width_growth, na.rm = TRUE)  # calculate mean growth rate
  )

# model against ph and temp
shell_width_model <- lm(shell_width_growth ~ pH * factor(temp), data = mayTeg)
anova(shell_width_model) # nothing significant

# avg model
may_wgrowth_model <- lm(avg_wgrowth_rate ~ pH * factor(temp), data = mayTeg_avg)
summary(may_wgrowth_model) # not significant

#visualize
mayTeg %>%
  filter(!is.na(temp)) %>% 
  ggplot(aes(x=pH, y=shell_width_growth, color = as.factor(temp)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(May~Shell~Width~Growth))
```

### Condition Index for Teg
```{r}
# calculate condition index
tegrespodry$CI <- tegrespodry$dry_weight/tegrespodry$dry_shell_weight*100

# model April
condition_index_model_a <- lm(CI ~ pH * temp_treatment, data = (tegrespodry %>% filter(experiment == "a")))
anova(condition_index_model_a) # pH is significant, increases with pH

tegrespodry %>% filter(experiment == "a") %>%
  ggplot(aes(x=pH, y=CI, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Condition~Index))

# model May
condition_index_model_b <- lm(CI ~ pH * temp_treatment, data = (tegrespodry %>% filter(experiment == "b")))
anova(condition_index_model_b) # not significant
tegrespodry %>% filter(experiment == "b") %>%
  ggplot(aes(x=pH, y=CI, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Condition~Index))
```
## Respiration

### Initial size diff
```{r echo=FALSE}
# graph of wet weight
initialsizeplot <-
tegrespodry %>%
  ggplot(aes(x=pH, y=initial_wet_weight))+
 facet_wrap(~experiment,labeller = as_labeller(c("a" = "Early spring", "b" = "Late spring")))+
  geom_point(aes(color = temp_treatment, fill = temp_treatment), alpha = 0.5)+
  stat_summary(
  aes(x = 7.6, y = initial_wet_weight),  # fixed x-position for all points
  fun.data = mean_sdl,
  fun.args = list(mult = 1),
  geom = "pointrange",
  size = 1,
  color = "black",
  inherit.aes = FALSE)+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1"))+ 
  scale_y_continuous(limits = c(0,5))+
  scale_x_continuous(limits = c(7.1,8.1))+
  labs(x = expression(pH),
      color = expression(paste("Temperature (",degree,"C)")),
      fill = expression(paste("Temperature (",degree,"C)")),
      y = expression(Intitial~wet~weight~(g)))

# get shell data in one place for graph
aprilTeg$experiment <- "Early spring"
mayTeg$experiment <- "Late spring"
tegulaSizes <- rbind(aprilTeg, mayTeg)

tegsize <- tegrespodry %>%
  group_by(experiment) %>%
  summarize (
    avg_size = mean(initial_wet_weight, na.rm = TRUE)
  )

# graph for shell data
initialshellplot <-
tegulaSizes %>%
  filter(!is.na(dry_shell)) %>%
  ggplot(aes(x=pH, y=shell_length_mm))+
 facet_wrap(~experiment)+
  geom_point(aes(color = as.factor(temp), fill = as.factor(temp)), alpha = 0.5)+
  stat_summary(
  aes(x = 7.6, y = shell_length_mm),  # fixed x-position for all points
  fun.data = mean_sdl,
  fun.args = list(mult = 1),
  geom = "pointrange",
  size = 1,
  color = "black",
  inherit.aes = FALSE)+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  scale_x_continuous(limits = c(7.1,8.1))+
  labs(x = expression(pH),
      color = expression(paste("Temperature (",degree,"C)")),
      fill = expression(paste("Temperature (",degree,"C)")),
      y = expression(Intitial~shell~length~(mm)))

initialsizeplot + initialshellplot + plot_layout(guides = "collect", axes = "collect_x")

ggsave("initial snails.png", path=here("Output"), width = 10, height = 5)
```

### Without considering size
```{r}
tegrespo_avg <- tegrespodry %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_res = mean(Respiration, na.rm = TRUE)  # calculate mean respo rate
  )

summary(tegrespodry)

tegmodel_april <- lm(avg_res ~ pH * temp_treatment, data=tegrespo_avg %>% filter(experiment == "a"))
#plot(tegmodel_april) 
anova(tegmodel_april) # nothing sig

tegmodel_may <- lm(avg_res ~ pH * temp_treatment, data=tegrespo_avg %>% filter(experiment == "b"))
#plot(tegmodel_may)
anova(tegmodel_may) # temp sig

# find averages by temperature to calculate % increase
tegrespo_avgrates <- tegrespo_avg %>%
  group_by(experiment, temp_treatment) %>%
  summarise(
    mean_respo = mean(avg_res, na.rm = TRUE)
  )

# avg model
avg_res_model <- lm(avg_res ~ pH * temp_treatment * experiment, data = tegrespo_avg)
anova(avg_res_model) 
summary(avg_res_model)

# avg plot

# predict using model
tegrespodry <- tegrespodry %>%
  mutate(predicted_res = predict(avg_res_model, newdata = tegrespodry))

predictions <- predict(avg_res_model, newdata = tegrespodry, interval = "confidence")

# Add predictions and confidence intervals to calc_new
tegrespodry <- tegrespodry %>%
  mutate(predicted_res = predictions[, "fit"],
         lower_ci = predictions[, "lwr"],  # Lower confidence bound
         upper_ci = predictions[, "upr"])  # Upper confidence bound

# avg plot
avgtegrespoplot <- 
tegrespodry %>%
  ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "Early spring", "b" = "Late spring"))) +
  geom_point(alpha = 0.1) + # raw data
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = as.factor(temp_treatment)), alpha = 0.3, color = NA) + # confidence interval
  geom_point(data = tegrespo_avg, aes(y = avg_res), 
             color = "black", size = 2, alpha = 0.8, shape = 21) +  
  geom_line(aes(y = predicted_res), size = 1.2) + # add model line
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

### Initial size vs respo plot
```{r eval = FALSE, echo=FALSE}
#making lm
lmtegsize <- lm(Respiration ~ initial_wet_weight, data = tegrespodry) #predicting respo from weight
tegrespodry <- tegrespodry %>%
  mutate(model = predict(lmtegsize)) #adding model prediction for plot
anova(lmtegsize) # wet weight very significant
summary(lmtegsize)

#graph
tegrespodry %>%
  ggplot(aes(x=initial_wet_weight, y=Respiration))+
  stat_summary(aes(color = as.factor(temp_treatment)), fun.data = mean_se, fun.args = list(mult = 1), 
               geom = "pointrange", size = 0.5) +
  geom_line(aes(y = model)) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1"))+ 
  scale_y_continuous(limits = c(0,100))+
  scale_x_continuous(limits = c(1,3))+
  labs(x = expression(Initial~wet~weight~(g)),
      color = expression(paste("Temperature (",degree,"C)")),
      fill = expression(paste("Temperature (",degree,"C)")),
      y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```
  
## Okay, what if we control for initial weight
```{r eval = FALSE, echo = FALSE}
tegmodel_weight <- lm(Respiration ~ dry_weight, data = tegrespodry) # predicting resp from initial weight
#plot(tegmodel_weight)
tegrespodry$residuals <- residuals(tegmodel_weight) #take residuals from weight prediction

tegrespodry <- tegrespodry %>%
  mutate(temp_treatment = as.factor(temp_treatment)) #making temp a factor

# April
tegmodel_res_april <- lm(residuals ~ pH * temp_treatment, data=tegrespodry %>% filter(experiment == "a"))
#plot(tegmodel_res)
anova(tegmodel_res_april) #model stats, temp, ph x exp, and temp x exp significant
summary(tegmodel_res_april)

# May
tegmodel_res_may <- lm(residuals ~ pH * temp_treatment, data=tegrespodry %>% filter(experiment == "b"))
#plot(tegmodel_res)
anova(tegmodel_res_may) #model stats, temp, ph x exp, and temp x exp significant
summary(tegmodel_res_may)

tegrespodry %>%
  ggplot(aes(x=pH, y=residuals, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Residuals~(mu*mol~O[2]~g^-1~hr^-1)))

# ok what if we averaged
tegrespo_avg <- tegrespodry %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_res = mean(residuals, na.rm = TRUE)  # calculate mean respo rate
  )

#avg model
avg_res_model <- lm(avg_res ~ pH * temp_treatment * experiment, data = tegrespo_avg)
anova(avg_res_model) 
summary(avg_res_model)

# april avg model
avg_res_model_april <- lm(avg_res ~ pH * temp_treatment, data = tegrespo_avg %>% mutate(temp_treatment = as.numeric(temp_treatment))%>% filter(experiment == "a"))
anova(avg_res_model_april) # nothing sig
summary(avg_res_model_april)

# may avg model
avg_res_model_may <- lm(avg_res ~ pH * temp_treatment, data = tegrespo_avg %>% filter(experiment == "b"))
anova(avg_res_model_may) # temp sig
summary(avg_res_model_may)

# avg plot

# predict using model
tegrespodry <- tegrespodry %>%
  mutate(predicted_res = predict(avg_res_model, newdata = tegrespodry))

predictions <- predict(avg_res_model, newdata = tegrespodry, interval = "confidence")

# Add predictions and confidence intervals to calc_new
tegrespodry <- tegrespodry %>%
  mutate(predicted_res = predictions[, "fit"],
         lower_ci = predictions[, "lwr"],  # Lower confidence bound
         upper_ci = predictions[, "upr"])  # Upper confidence bound

# avg plot
#avgtegrespoplot <- 
tegrespodry %>%
  ggplot(aes(x = pH, y = residuals, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_point(alpha = 0.2) + # raw data
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = as.factor(temp_treatment)), alpha = 0.3, color = NA) + # confidence interval
  geom_point(data = tegrespo_avg, aes(y = avg_res), 
             color = "black", size = 2, alpha = 0.8, shape = 21) +  
  geom_line(aes(y = predicted_res), size = 1.2) + # add model line
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Residuals~(mu*mol~O[2]~g^-1~hr^-1)))

```

### Respo metabolic scaling?
```{r}
# april
tegresposcale_a <- lm(log(Respiration) ~ log(dry_weight), data = tegrespodry %>%
                      filter(experiment == "a"))
anova(tegresposcale_a)
summary(tegresposcale_a) # -.91 slope

  #add covariates
tegresposcale_full_a <- lm(log(Respiration) ~ log(dry_weight) * pH * temp_treatment, 
                         data = tegrespodry %>%
                            filter(experiment == "a"))
anova(tegresposcale_full_a) # no interactions
plot(tegresposcale_full_a)
tegresposcale_noint_a <- lm(log(Respiration) ~ log(dry_weight) + pH + temp_treatment, 
                            data = tegrespodry %>%
                            filter(experiment == "a"))
anova(tegresposcale_full_a,tegresposcale_noint_a) # do not need interactions

# may 
tegresposcale_b <- lm(log(Respiration) ~ log(dry_weight), data = tegrespodry %>%
                      filter(experiment == "b"))
anova(tegresposcale_b)
summary(tegresposcale_b) # -.2 slope

  #add covariates
tegresposcale_full_b <- lm(log(Respiration) ~ log(dry_weight) * pH * temp_treatment, 
                         data = tegrespodry %>%
                            filter(experiment == "b"))
anova(tegresposcale_full_b) # dry weight: temp sig
plot(tegresposcale_full_b)
tegresposcale_noint_b <- lm(log(Respiration) ~ log(dry_weight) + pH + temp_treatment, 
                            data = tegrespodry %>%
                            filter(experiment == "b"))
anova(tegresposcale_full_b,tegresposcale_noint_b) # need interactions

  #calculate slopes
tegrespodryish <- tegrespodry %>%
  mutate(pH = as.factor(pH))
tegresposcale_full_factor_b <- lm(log(Respiration) ~ log(dry_weight) * pH * temp_treatment, 
                                data = tegrespodryish %>%
                                  filter(experiment == "b"))
anova(tegresposcale_full_factor_b)
slopes <- emtrends(tegresposcale_full_factor_b, ~ pH * temp_treatment, var = "log(dry_weight)")
summary(slopes)

# all together now
tegresposcale <- lm(log(Respiration) ~ log(dry_weight), data = tegrespodry)
anova(tegresposcale)
summary(tegresposcale)

# add covariates
tegresposcale_full <- lm(log(Respiration) ~ log(dry_weight) * pH * temp_treatment, data = tegrespodry)
anova(tegresposcale_full) #there ARE interactions
plot(tegresposcale_full)
tegresposcale_noint <- lm(log(Respiration) ~ log(dry_weight) + pH + temp_treatment, data = tegrespodry)
anova(tegresposcale_full,tegresposcale_noint) # need to include interactions

# okay generate slopes per group
tegrespodryish <- tegrespodry %>%
  mutate(pH = as.factor(pH))
tegresposcale_full_factor <- lm(log(Respiration) ~ log(dry_weight) * pH * temp_treatment, data = tegrespodryish)
anova(tegresposcale_full_factor)
slopes <- emtrends(tegresposcale_full_factor, ~ pH * temp_treatment, var = "log(dry_weight)")
summary(slopes)

```

### Respo effect size plot
```{r}
tegrespo_avg <- tegrespo_avg %>%
  ungroup() %>%
  mutate(temp_num = as.numeric(as.character(temp_treatment))) %>% # make temp a number
  mutate(pH_scale = as.numeric(scale(pH)), # scale the values so that you can calculated standardized effects
         temp_scale = as.numeric(scale(temp_num)))

# April - run your model on the scaled data for april
tegmodel_res_april <- lm(avg_res ~ pH_scale * temp_scale, data=tegrespo_avg %>% filter(experiment == "a"))
#plot(tegmodel_res_april)
anova(tegmodel_res_april) # nothing sig
summary(tegmodel_res_april)

# May - again in may
tegmodel_res_may <- lm(avg_res ~ pH_scale * temp_scale, data=tegrespo_avg %>% filter(experiment == "b"))
#plot(tegmodel_res)
anova(tegmodel_res_may) # temp sig
summary(tegmodel_res_may)


### Extract the standardized effect sizes using the effectsize function from emmeans (this is using cohens_d, I believe, which scales everything on 0 - 1)

std_coefs<-as_tibble(effectsize(tegmodel_res_april)) %>% # get the effect sizes for april
  mutate(month = "Early spring") %>% # add the season
  left_join(tidy(tegmodel_res_april) %>%
              dplyr::select(Parameter = term, p.value)) %>% # bring in the p-values from the summary of the model (which is now correct now that the values are standardized -- Note you STILL report the ANOVA results when talking about your significance in the model.  These p-values essentially tell you if the values are different or not from your intercept (essentiall 0))
  bind_rows(as_tibble(effectsize(tegmodel_res_may)) %>% # bind it to the same for May
              mutate(month = "Late spring") %>%
              left_join(tidy(tegmodel_res_may) %>%
                          dplyr::select(Parameter = term, p.value))) %>%
  filter(Parameter != "(Intercept)") %>% # remove the intercepts for the STD Coef plot
  mutate(Parameter = case_when(Parameter == "temp_scale" ~"Temperature",
                               Parameter == "pH_scale" ~"pH",
                               Parameter == "pH_scale:temp_scale"~"pH:Temperature")) %>% # make names prettier
  mutate(Parameter = factor(Parameter, levels = c("pH:Temperature","Temperature","pH"))) %>% # put it in the order I want
  mutate(significant = ifelse(p.value < 0.055, 1, 0.2)) # use this to change the alpha of points that are not significant


# make a standardized effects plot
tegrespoplot <- 
  std_coefs %>%
  ggplot(aes(x = Std_Coefficient, y = Parameter, color = month, alpha = significant))+
  geom_vline(xintercept = 0, lty = 3)+
  geom_point(size = 3, 
             position = position_dodge(width = 0.2))+ # offset the points a little bit so not on top of each other by month
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), 
                 height = 0.1, position = position_dodge(width = 0.2))+
  labs(x = "Standardized Effect Size \n Respiration", 
       y = "",
       color = "")+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  scale_alpha(range = c(0.3,1))+
  guides(alpha = "none")+ # don't show the alpha legend
  theme_bw()+
  theme(axis.title = element_text(size = 14),# need ggtext loaded for this to work
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))
```

 
## Calcification
```{r}
# bring in metadata
calc_new <- calc %>%
  mutate(ID = as.factor(ID)) %>%
  left_join(Teg.Sample.Info.New %>% 
            dplyr::select(ID,pH,experiment)) %>%
  mutate(temp_treatment = as.factor(temp_treatment)) %>%
  mutate(experiment = as.factor(experiment))

calc_lm <- lm(umol.cm2.hr ~ wet_weight, data=calc)
anova(calc_lm)
summary(calc_lm) # wet weight does not predict calc

# check outliers
calc_out <- calc %>%
  filter(deltaTA > mean(deltaTA, na.rm = TRUE) + 3 * sd(deltaTA, na.rm = TRUE))

summary(calc)

# model calc with all interaction terms
tegmodel_calc_notank <- lm(umol.cm2.hr ~ pH * temp_treatment * experiment, data=calc_new)
anova(tegmodel_calc_notank) # pH x temp, temp x exp, ph x exp
summary(tegmodel_calc_notank)

# normal plot
calc_new %>%
  ggplot(aes(x=pH, y=umol.cm2.hr, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Calcification~rate~(CaCO[3]~g^-1~hr^-1)))

# calculate averages 
calc_avg <- calc_new %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean calc rate
  )

# find averages by temperature to calculate % increase
calcrespo_avgrates <- calc_avg %>%
  group_by(experiment, temp_treatment) %>%
  summarise(
    mean_calc = mean(avg_calc, na.rm = TRUE)
  )

# find averages by pH to calculate % increase
calcrespo_avgrates <- calc_avg %>%
  group_by(experiment, pH) %>%
  summarise(
    mean_calc = mean(avg_calc, na.rm = TRUE)
  )

# april avg model
avg_calc_model_april <- lm(avg_calc ~ pH * temp_treatment, data = calc_avg %>% filter(experiment == "a"))
anova(avg_calc_model_april) # nothing sig
summary(avg_calc_model_april) 

# may avg model
avg_calc_model_may <- lm(avg_calc ~ pH * temp_treatment, data = calc_avg %>% filter(experiment == "b"))
anova(avg_calc_model_may) # pH and temp sig
summary(avg_calc_model_may) 

# avg model altogether
avg_calc_model <- lm(avg_calc ~ pH * temp_treatment * experiment, data = calc_avg)
anova(avg_calc_model) # ph x exp, temp x exp
summary(avg_calc_model) 


# april avg model
avg_calc_model_april <- lm(avg_calc ~ pH * temp_treatment, data = calc_avg_out %>% filter(experiment == "a"))
anova(avg_calc_model_april) # nothing sig
summary(avg_calc_model_april) 

# may avg model
avg_calc_model_may <- lm(avg_calc ~ pH * temp_treatment, data = calc_avg_out %>% filter(experiment == "b"))
anova(avg_calc_model_may) # pH and temp sig
summary(avg_calc_model_may) 

# avg model altogether
avg_calc_model <- lm(avg_calc ~ pH * temp_treatment * experiment, data = calc_avg_out)
anova(avg_calc_model) # ph x exp, temp x exp
summary(avg_calc_model) 

# avg plot

# predict using model
calc_new <- calc_new %>%
  mutate(predicted_calc = predict(avg_calc_model, newdata = calc_new))

predictions <- predict(avg_calc_model, newdata = calc_new, interval = "confidence")

# Add predictions and confidence intervals to calc_new
calc_new <- calc_new %>%
  mutate(predicted_calc = predictions[, "fit"],
         lower_ci = predictions[, "lwr"],  # Lower confidence bound
         upper_ci = predictions[, "upr"])  # Upper confidence bound

# avg plot
avgcalcplot <-
calc_new %>%
  ggplot(aes(x = pH, y = umol.cm2.hr, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "Early spring", "b" = "Late spring"))) +
  geom_point(alpha = 0.1) + # raw data
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = as.factor(temp_treatment)), alpha = 0.3, color = NA) + # confidence interval
  geom_point(data = calc_avg, aes(y = avg_calc), 
             color = "black", size = 2, alpha = 0.8, shape = 21) +  
  geom_line(aes(y = predicted_calc), size = 1.2) + # add model line
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)))
```

### Shell calcification
```{r}
shellcalc %>%
  ggplot(aes(x=pH_treatment, y=umol.cm2.hr, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.2)+
  #geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 16)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Calcification~rate~(mu*mol~CaCO[3]~hr^-1)))
```

### determine proportion of shell calc to real calc
```{r}
calc_avg_ish <- calc_new %>%
  group_by(pH_treatment, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean calc rate
  )

shell_avg <- shellcalc %>%
  group_by(pH_treatment, temp_treatment) %>%  # group by temp and pH
  summarize(
    shell_avg = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean calc rate
  )

allshells <- shell_avg %>%
  mutate(temp_treatment = as.factor(temp_treatment)) %>%
  inner_join(calc_avg_ish, by = c("pH_treatment", "temp_treatment"))

allshells <- allshells %>%
  mutate(proportion = shell_avg / avg_calc)
```

### Calc effect size plot
```{r}
calc_avg<-calc_avg %>%
  ungroup() %>%
  mutate(temp_num = as.numeric(as.character(temp_treatment))) %>% # make temp a number
  mutate(pH_scale = as.numeric(scale(pH)), # scale the values so that you can calculated standardized effects
         temp_scale = as.numeric(scale(temp_num)))

# April - run your model on the scaled data for april
tegmodel_cal_april <- lm(avg_calc ~ pH_scale * temp_scale, data=calc_avg %>% filter(experiment == "a"))
#plot(tegmodel_res)
anova(tegmodel_cal_april) # nothing sig
summary(tegmodel_cal_april)

# May - again in may
tegmodel_cal_may <- lm(avg_calc ~ pH_scale * temp_scale, data=calc_avg %>% filter(experiment == "b"))
#plot(tegmodel_res)
anova(tegmodel_cal_may) # ph and temp sig
summary(tegmodel_cal_may)


### Extract the standardized effect sizes using the effectsize function from emmeans (this is using cohens_d, I believe, which scales everything on 0 - 1)

std_coefs<-as_tibble(effectsize(tegmodel_cal_april)) %>% # get the effect sizes for april
  mutate(month = "Early spring") %>% # add the month
  left_join(tidy(tegmodel_cal_april) %>%
              dplyr::select(Parameter = term, p.value)) %>% # bring in the p-values from the summary of the model (which is now correct now that the values are standardized -- Note you STILL report the ANOVA results when talking about your significance in the model.  These p-values essentially tell you if the values are different or not from your intercept (essentiall 0))
  bind_rows(as_tibble(effectsize(tegmodel_cal_may)) %>% # bind it to the same for May
              mutate(month = "Late spring") %>%
              left_join(tidy(tegmodel_cal_may) %>%
                          dplyr::select(Parameter = term, p.value))) %>%
  filter(Parameter != "(Intercept)") %>% # remove the intercepts for the STD Coef plot
  mutate(Parameter = case_when(Parameter == "temp_scale" ~"Temperature",
                               Parameter == "pH_scale" ~"pH",
                               Parameter == "pH_scale:temp_scale"~"pH:Temperature")) %>% # make names prettier
  mutate(Parameter = factor(Parameter, levels = c("pH:Temperature","Temperature","pH"))) %>% # put it in the order I want
  mutate(significant = ifelse(p.value < 0.055, 1, 0.2)) # use this to change the alpha of points that are not significant


# make a standardized effects plot. You will eventually bring these different ones together in patchwork like we talked about in person 
tegcalcplot <-
std_coefs %>%
  ggplot(aes(x = Std_Coefficient, y = Parameter, color = month, alpha = significant))+
  geom_vline(xintercept = 0, lty = 3)+
  geom_point(size = 3, 
             position = position_dodge(width = 0.2))+ # offset the points a little bit so not on top of eachother by month
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), 
                 height = 0.1, position = position_dodge(width = 0.2))+
  labs(x = "Standardized Effect Size \n Calcification", 
       y = "",
       color = "")+
  scale_alpha(range = c(0.3,1))+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  guides(alpha = "none")+ # don't show the alpha legend
  theme_bw()+
  theme(axis.title = element_text(size = 14),# neeg ggtext loaded for this to work
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))

# patchwork guide = collect to show one legend
```

### C:R
```{r eval=FALSE,echo=FALSE}
tegcalcresp <- tegrespodry %>%
  dplyr::select(ID,experiment,Respiration,pH,temp_treatment) %>%
  left_join(calc %>%
              mutate(ID = as.factor(ID)) %>%
              dplyr::select(ID, experiment,umol.cm2.hr)) %>%
  mutate(calc_r = umol.cm2.hr/Respiration) %>%
  filter(calc_r < 0.075, calc_r > -0.07)

tegcrespmodel <- lm(calc_r ~ pH * temp_treatment * factor(experiment), data=tegcalcresp)
anova(tegcrespmodel) # ph, temp significant
summary(tegcrespmodel)

# april
tegcrespmodel_april <- lm(calc_r ~ pH * temp_treatment, data=tegcalcresp %>% filter(experiment == "a"))
anova(tegcrespmodel_april) # ph x temp significant
summary(tegcrespmodel_april)

# may
tegcrespmodel_may <- lm(calc_r ~ pH * temp_treatment, data=tegcalcresp %>% filter(experiment == "b"))
anova(tegcrespmodel_may) # ph and temp significant
summary(tegcrespmodel_may)

tegcalcresp %>%
  ggplot(aes(x=pH, y = calc_r, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha = 0.5)+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(y = expression(Calcification:Respiration),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       x = expression(pH[T]))

# calculate averages 
calc_r_avg <- tegcalcresp %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_calcr = mean(calc_r, na.rm = TRUE)  # calculate mean calc:r rate
  )

# april avg model
avg_calc_model_april <- lm(avg_calcr ~ pH * temp_treatment, data = calc_r_avg %>% filter (experiment == "a"))
anova(avg_calc_model_april)
summary(avg_calc_model) 

# may avg model
avg_calc_model_may <- lm(avg_calcr ~ pH * temp_treatment, data = calc_r_avg %>% filter (experiment == "b"))
anova(avg_calc_model_may) # ph, temp
summary(avg_calc_model_may) 

# avg plot

calc_r_avg %>%
  ggplot(aes(x=pH, y = avg_calcr, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~experiment,labeller = as_labeller(c("a" = "April", "b" = "May")))+
  geom_point(alpha = 0.5)+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(y = expression(Calcification:Respiration),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       x = expression(pH[T]))
```

# Rockweed

## Gross Photosynthesis

### Clean respo
```{r}
rwrespo <- respo_dry_clean %>%
  filter(Species == "Rockweed", Respiration != 0) # filter out snails


RW.Sample.Info.New <- Sample.Info.New %>%
  filter(Species == "Rockweed", BLANK == "0") # filter out snails

rwrespo$ID <- as.factor(rwrespo$ID)
rwrespo <- rwrespo %>%
  left_join(RW.Sample.Info.New %>% dplyr::select(pH, experiment, ID) %>%
  distinct(experiment, ID, .keep_all = TRUE), by = c("experiment","ID")) # bring in sample info

rwrespo_clean <- rwrespo %>%
    filter(!is.na(Respiration) & !is.nan(Respiration) & !is.infinite(Respiration)) # get rid of any NAs

rwrespo_clean <- rwrespo_clean %>% filter(NetPhoto > 0) # get rid of outliers

rwrespo_clean <- rwrespo_clean %>%
  mutate(temp_treatment = as.factor(temp_treatment), experiment = as.factor(experiment)) # make factors
```

### GP just controls
```{r eval = FALSE, echo = FALSE}
rwmodelGP <- lm(GrossPhoto ~ pH * temp_treatment  *experiment, data=rwrespo_clean %>% filter(predator == "c"))
anova(rwmodelGP) #model stats, exp, ph x temp, ph x exp sig
summary(rwmodelGP)

rwrespo_clean %>%  
  filter(predator == "c") %>%
   ggplot(aes(x = pH, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha=0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Gross~Photosynthetic~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# using PCO2

rwmodelGP2 <- lm(GrossPhoto ~ pCO2 * temp_treatment  *experiment, data=rwrespo_clean %>% filter(predator == "c"))
anova(rwmodelGP2)

rwrespo_clean %>%  
  filter(predator == "c") %>%
   ggplot(aes(x = pCO2, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha=0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pCO[2]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Gross~Photosynthetic~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

```

### GP with predation
```{r, echo = FALSE}
# start with april, do we see differences with predation?
rwmodelGP_a <- lm(GrossPhoto ~ pH * temp_treatment * predator, data=rwrespo_clean %>% filter(experiment == "a"))
anova(rwmodelGP_a) #model stats, pH sig
summary(rwmodelGP_a)

rwmodelGP_aR_full <- lm(GrossPhoto ~ pH * temp_treatment + predator, 
                    data = rwrespo_clean %>% filter(experiment == "a"))
rwmodelGP_aR_reduced <- lm(GrossPhoto ~ pH * temp_treatment, 
                      data = rwrespo_clean %>% filter(experiment == "a"))
anova(rwmodelGP_aR_reduced,rwmodelGP_aR_full)


rwrespo_clean %>% 
  filter(experiment == "a") %>%
   ggplot(aes(x = pH, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~predator, labeller = as_labeller(c("p" = "predator", "c" = "control"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# what about may?

rwmodelGP_bR_full <- lm(GrossPhoto ~ pH * temp_treatment + predator, 
                    data = rwrespo_clean %>% filter(experiment == "b"))
rwmodelGP_bR_reduced <- lm(GrossPhoto ~ pH * temp_treatment, 
                      data = rwrespo_clean %>% filter(experiment == "b"))
anova(rwmodelGP_bR_reduced,rwmodelGP_bR_full)

rwmodelGP_b <- lm(GrossPhoto ~ pH * temp_treatment * (predator), data=rwrespo_clean %>% filter(experiment == "b"))
anova(rwmodelGP_b) #model stats, nothing sig
summary(rwmodelGP_b)

rwrespo_clean %>% 
  filter(experiment == "b") %>%
   ggplot(aes(x = pH, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~predator, labeller = as_labeller(c("p" = "predator", "c" = "control"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )
```

### GP including non-controls
```{r}
summary(rwrespo_clean)

# with non-control
rwmodel_GPall <- lm(GrossPhoto ~ pH * temp_treatment * experiment, data=rwrespo_clean)
anova(rwmodel_GPall) #model stats, exp, ph x exp sig

rwrespo_clean %>% 
  ggplot(aes(x = pH, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(GrossPhoto~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# ok what if we averaged
rwrespo_avg <- rwrespo_clean %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_gp = mean(GrossPhoto, na.rm = TRUE)  # calculate mean calc rate
  )

# getting temp diff
rwrespoavgavg <- rwrespo_avg %>%
  filter(experiment == "b") %>%
  group_by(temp_treatment) %>%
  summarize (avg_gp_temp = mean(avg_gp, na.rm = TRUE))

# avg model
avg_gp_model <- lm(avg_gp ~ pH * temp_treatment * experiment, data = rwrespo_avg)
anova(avg_gp_model) # exp, ph x exp sig
summary(avg_gp_model)

# april avg model
avg_gp_model_april <- lm(avg_gp ~ pH * temp_treatment, data = rwrespo_avg %>% filter(experiment == "a"))
anova(avg_gp_model_april) # pH
summary(avg_gp_model_april)

# may avg model
avg_gp_model_may <- lm(avg_gp ~ pH * temp_treatment, data = rwrespo_avg %>% filter(experiment == "b"))
anova(avg_gp_model_may) # pH
summary(avg_gp_model_may)

# avg plot

# predict using model
rwrespo_clean <- rwrespo_clean %>%
  mutate(predicted_gp = predict(avg_gp_model, newdata = rwrespo_clean))

predictions <- predict(avg_gp_model, newdata = rwrespo_clean, interval = "confidence")

# Add predictions and confidence intervals to calc_new
rwrespo_clean <- rwrespo_clean %>%
  mutate(predicted_gp = predictions[, "fit"],
         lower_ci = predictions[, "lwr"],  # Lower confidence bound
         upper_ci = predictions[, "upr"])  # Upper confidence bound

# avg plot
avggpplot <-
rwrespo_clean %>%
  ggplot(aes(x = pH, y = GrossPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "Early spring", "b" = "Late spring"))) +
  geom_point(alpha = 0.1) + # raw data
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = as.factor(temp_treatment)), alpha = 0.3, color = NA) + # confidence interval
  geom_point(data = rwrespo_avg, aes(y = avg_gp), 
             color = "black", size = 2, alpha = 0.8, shape = 21) +  
  geom_line(aes(y = predicted_gp), size = 1.2) + # add model line
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Gross~Photo~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

### GP effect size plot
```{r}
rwrespo_avg <- rwrespo_avg %>%
  ungroup() %>%
  mutate(temp_num = as.numeric(as.character(temp_treatment))) %>% # make temp a number
  mutate(pH_scale = as.numeric(scale(pH)), # scale the values so that you can calculated standardized effects
         temp_scale = as.numeric(scale(temp_num)))

# April - run your model on the scaled data for april
rwmodel_gp_april <- lm(avg_gp ~ pH_scale * temp_scale, data=rwrespo_avg %>% filter(experiment == "a"))
#plot(tegmodel_res)
anova(rwmodel_gp_april) # pH sig
summary(rwmodel_gp_april)

# May - again in may
rwmodel_gp_may <- lm(avg_gp ~ pH_scale * temp_scale, data=rwrespo_avg %>% filter(experiment == "b"))
#plot(tegmodel_res)
anova(rwmodel_gp_may) # pH sig
summary(rwmodel_gp_may)


### Extract the standardized effect sizes using the effectsize function from emmeans (this is using cohens_d, I believe, which scales everything on 0 - 1)

std_coefs<-as_tibble(effectsize(rwmodel_gp_april)) %>% # get the effect sizes for april
  mutate(month = "Early spring") %>% # add the month
  left_join(tidy(rwmodel_gp_april) %>%
              dplyr::select(Parameter = term, p.value)) %>% # bring in the p-values from the summary of the model (which is now correct now that the values are standardized -- Note you STILL report the ANOVA results when talking about your significance in the model.  These p-values essentially tell you if the values are different or not from your intercept (essentiall 0))
  bind_rows(as_tibble(effectsize(rwmodel_gp_may)) %>% # bind it to the same for May
              mutate(month = "Late spring") %>%
              left_join(tidy(rwmodel_gp_may) %>%
                          dplyr::select(Parameter = term, p.value))) %>%
  filter(Parameter != "(Intercept)") %>% # remove the intercepts for the STD Coef plot
  mutate(Parameter = case_when(Parameter == "temp_scale" ~"Temperature",
                               Parameter == "pH_scale" ~"pH",
                               Parameter == "pH_scale:temp_scale"~"pH:Temperature")) %>% # make names prettier
  mutate(Parameter = factor(Parameter, levels = c("pH:Temperature","Temperature","pH"))) %>% # put it in the order I want
  mutate(significant = ifelse(p.value < 0.055, 1, 0.5)) # use this to change the alpha of points that are not significant


# make a standardized effects plot. You will eventually bring these different ones together in patchwork like we talked about in person
rwgpplot <-
std_coefs %>%
  ggplot(aes(x = Std_Coefficient, y = Parameter, color = month, alpha = significant))+
  geom_vline(xintercept = 0, lty = 3)+
  geom_point(size = 3, 
             position = position_dodge(width = 0.2))+ # offset the points a little bit so not on top of eachother by month
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), 
                 height = 0.1, position = position_dodge(width = 0.2))+
  labs(x = "Standardized Effect Size \n Gross Photosynthesis", 
       y = "",
       color = "")+
  scale_alpha(range = c(0.3,1))+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  guides(alpha = "none")+ # don't show the alpha legend
  theme_bw()+
  theme(axis.title = element_text(size = 14),# neeg ggtext loaded for this to work
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))

# patchwork guide = collect to show one legend
```

## Respo
### Just controls
```{r eval = FALSE, echo = FALSE}
#Respiration
rwmodelR <- lm(Respiration ~ pH * temp_treatment * experiment, data=rwrespo_clean %>% filter(predator == "c"))
#plot(rwmodelR)
anova(rwmodelR) #model stats, temp, ph x temp, ph x exp
summary(rwmodelR)

rwrespo_clean %>% 
  filter(predator == "c") %>%
  ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )
```

### Respo with predation in model
```{r  echo=FALSE}
# start with april, do we see differences with predation?
rwmodelR_aR_full <- lm(Respiration ~ pH * temp_treatment + predator, 
                    data = rwrespo_clean %>% filter(experiment == "a"))
rwmodelR_aR_reduced <- lm(Respiration ~ pH * temp_treatment, 
                      data = rwrespo_clean %>% filter(experiment == "a"))
anova(rwmodelR_aR_reduced,rwmodelR_aR_full)

rwmodelRP_a <- lm(Respiration ~ pH * temp_treatment * predator, 
              data = rwrespo_clean %>% filter(experiment == "a"))
anova(rwmodelRP_a) #model stats, pH x temp, ph x temp x tank
summary(rwmodelRP_a)

rwrespo_clean %>% 
  filter(experiment == "a") %>%
   ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~predator, labeller = as_labeller(c("p" = "predator", "c" = "control"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(April~respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# what about may?
rwmodelR_bR_full <- lm(Respiration ~ pH * temp_treatment + predator, 
                    data = rwrespo_clean %>% filter(experiment == "b"))
rwmodelR_bR_reduced <- lm(Respiration ~ pH * temp_treatment, 
                      data = rwrespo_clean %>% filter(experiment == "b"))
anova(rwmodelR_bR_reduced,rwmodelR_bR_full)

rwmodelRP_b <- lm(Respiration ~ pH * temp_treatment * predator, 
                  data=rwrespo_clean %>% filter(experiment == "b"))
anova(rwmodelRP_b) #model stats, temp sig
summary(rwmodelRP_b)

rwrespo_clean %>% 
  filter(experiment == "b") %>%
   ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~predator, labeller = as_labeller(c("p" = "predator", "c" = "control"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(May~respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )
```
### Respo all together
```{r}
# with non-control
rwmodel_Rall <- lm(Respiration ~ pH * temp_treatment * experiment, data=rwrespo_clean)
anova(rwmodel_Rall) #model stats, temp, ph x temp, ph x exp, ph x temp x exp

rwrespo_clean %>% 
  ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# ok what if we averaged
rwrespo_avg <- rwrespo_clean %>%
  group_by(pH, temp_treatment, experiment) %>%  # group by temp and pH
  summarize(
    avg_respo = mean(Respiration, na.rm = TRUE)  # calculate mean calc rate
  )

# avg model
avg_respo_model <- lm(avg_respo ~ pH * temp_treatment * experiment, data = rwrespo_avg)
anova(avg_respo_model) # temp sig
summary(avg_respo_model)

# avg model april
avg_respo_model_april <- lm(avg_respo ~ pH * temp_treatment, data = rwrespo_avg %>% filter(experiment == "a"))
anova(avg_respo_model_april) # ph x temp sig
summary(avg_respo_model_april)

# avg model may
avg_respo_model_may <- lm(avg_respo ~ pH * temp_treatment, data = rwrespo_avg %>% filter(experiment == "b"))
anova(avg_respo_model_may) # nothing
summary(avg_respo_model_may)


# avg plot

# predict using model
rwrespo_clean <- rwrespo_clean %>%
  mutate(predicted_respo = predict(avg_respo_model, newdata = rwrespo_clean))

predictions <- predict(avg_respo_model, newdata = rwrespo_clean, interval = "confidence")

# Add predictions and confidence intervals to calc_new
rwrespo_clean <- rwrespo_clean %>%
  mutate(predicted_respo = predictions[, "fit"],
         lower_ci = predictions[, "lwr"],  # Lower confidence bound
         upper_ci = predictions[, "upr"])  # Upper confidence bound

# avg plot
avgrwrespoplot <-
rwrespo_clean %>%
  ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "Early spring", "b" = "Late spring"))) +
  geom_point(alpha = 0.1) + # raw data
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = as.factor(temp_treatment)), alpha = 0.3, color = NA) + # confidence interval
  geom_point(data = rwrespo_avg, aes(y = avg_respo), 
             color = "black", size = 2, alpha = 0.8, shape = 21) +  
  geom_line(aes(y = predicted_respo), size = 1.2) + # add model line
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature (",degree,"C)")),
       fill = expression(paste("Temperature (",degree,"C)")),
       y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

### Respo effect size plot
```{r}
rwrespo_avg <- rwrespo_avg %>%
  ungroup() %>%
  mutate(temp_num = as.numeric(as.character(temp_treatment))) %>% # make temp a number
  mutate(pH_scale = as.numeric(scale(pH)), # scale the values so that you can calculated standardized effects
         temp_scale = as.numeric(scale(temp_num)))

# April - run your model on the scaled data for april
rwmodel_res_april <- lm(avg_respo ~ pH_scale * temp_scale, data=rwrespo_avg %>% filter(experiment == "a"))
#plot(tegmodel_res)
anova(rwmodel_res_april) # ph x temp sig
summary(rwmodel_res_april)

# May - again in may
rwmodel_res_may <- lm(avg_respo ~ pH_scale * temp_scale, data=rwrespo_avg %>% filter(experiment == "b"))
#plot(tegmodel_res)
anova(rwmodel_res_may) # nothing sig
summary(rwmodel_res_may)


### Extract the standardized effect sizes using the effectsize function from emmeans (this is using cohens_d, I believe, which scales everything on 0 - 1)

std_coefs<-as_tibble(effectsize(rwmodel_res_april)) %>% # get the effect sizes for april
  mutate(month = "Early spring") %>% # add the month
  left_join(tidy(rwmodel_res_april) %>%
              dplyr::select(Parameter = term, p.value)) %>% # bring in the p-values from the summary of the model (which is now correct now that the values are standardized -- Note you STILL report the ANOVA results when talking about your significance in the model.  These p-values essentially tell you if the values are different or not from your intercept (essentiall 0))
  bind_rows(as_tibble(effectsize(rwmodel_res_may)) %>% # bind it to the same for May
              mutate(month = "Late spring") %>%
              left_join(tidy(rwmodel_res_may) %>%
                          dplyr::select(Parameter = term, p.value))) %>%
  filter(Parameter != "(Intercept)") %>% # remove the intercepts for the STD Coef plot
  mutate(Parameter = case_when(Parameter == "temp_scale" ~"Temperature",
                               Parameter == "pH_scale" ~"pH",
                               Parameter == "pH_scale:temp_scale"~"pH:Temperature")) %>% # make names prettier
  mutate(Parameter = factor(Parameter, levels = c("pH:Temperature","Temperature","pH"))) %>% # put it in the order I want
  mutate(significant = ifelse(p.value < 0.055, 1, 0.5)) # use this to change the alpha of points that are not significant


# make a standardized effects plot. You will eventually bring these different ones together in patchwork like we talked about in person 
rwrespoplot <-
std_coefs %>%
  ggplot(aes(x = Std_Coefficient, y = Parameter, color = month, alpha = significant))+
  geom_vline(xintercept = 0, lty = 3)+
  geom_point(size = 3, 
             position = position_dodge(width = 0.2))+ # offset the points a little bit so not on top of eachother by month
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), 
                 height = 0.1, position = position_dodge(width = 0.2))+
  labs(x = "Standardized Effect Size \n Respiration", 
       y = "",
       color = "")+
  scale_alpha(range = c(0.3,1))+
  scale_color_manual(values = c("#540D6E", "#0EAD69"))+
  guides(alpha = "none")+ # don't show the alpha legend
  theme_bw()+
  theme(axis.title = element_text(size = 14),# neeg ggtext loaded for this to work
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))

# patchwork guide = collect to show one legend
```

## Net Photosynthesis

### Only controls
```{r eval=FALSE, echo=FALSE}
rwmodelNP <- lm(NetPhoto ~ pH * temp_treatment * experiment, data=rwrespo_clean %>% filter (predator == "c"))
anova(rwmodelNP) #model stats, exp, ph x exp, temp x exp sig
summary(rwmodelNP)

rwrespo_clean %>%
  filter(predator == "c") %>%
  ggplot(aes(x = pH, y = NetPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Net~Photosynthetic~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )
```

### With non-controls
```{r eval=FALSE,echo=FALSE}
rwmodelNP_all <- lm(NetPhoto ~ pH * temp_treatment * experiment, data=rwrespo_clean)
anova(rwmodelNP_all) #model stats, exp, ph x expsig
summary(rwmodelNP_all)

rwrespo_clean %>%
  ggplot(aes(x = pH, y = NetPhoto, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(Net~Photosynthetic~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )
```

### GP/R
```{r eval=FALSE, echo = FALSE}
rwmodelGPR <- lm((GrossPhoto/Respiration) ~ pH * temp_treatment * experiment, data=rwrespo_clean %>% filter(predator == "c"))
#plot(rwmodelGP)
anova(rwmodelGPR) #model stats, temp sig
rwrespo_clean %>%
 filter(predator == "c", GrossPhoto/Respiration < 20) %>%
   ggplot(aes(x = pH, y = (GrossPhoto/Respiration), color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha=0.5)+
  facet_wrap(~experiment, labeller = as_labeller(c("a" = "April", "b" = "May"))) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(GP:R)
  )


```

## C:N Ratio
```{r eval = FALSE, echo = FALSE}
cn <- cn %>%
  left_join(aprilpH %>% filter(date == 20240402) %>% dplyr::select(tank, expected_pH, expected_temp), by = "tank")

cn<-cn %>%
  mutate(weight_ug = weight_mg*1000, # convert weight to micrograms
         N_percent = n_ug/weight_ug*100, # calculate N percent
         C_percent = c_ug/weight_ug*100, # calculate C percent
         C_N = c_ug/n_ug)
cn %>%
ggplot(aes(x = expected_pH, y = C_N, color = as.factor(expected_temp), fill = as.factor(expected_temp))) +
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(C:N)
  )

cnmodel <- lm(C_N ~ expected_pH * expected_temp, data=cn)
anova(cnmodel)
```

### C13
```{r eval = FALSE, echo = FALSE}
cn %>%
ggplot(aes(x = expected_pH, y = c13, color = as.factor(expected_temp), fill = as.factor(expected_temp))) +
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(C13)
    )
cmodel <- lm(c13 ~ expected_pH * expected_temp, data=cn)
anova(cmodel)
```

### N15
```{r eval = FALSE, echo = FALSE}
cn %>%
ggplot(aes(x = expected_pH, y = n15, color = as.factor(expected_temp), fill = as.factor(expected_temp))) +
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(N15)
    )

nmodel <- lm(n15 ~ expected_pH * expected_temp, data=cn)
anova(nmodel)
```

### % C
```{r, eval=FALSE, echo = FALSE}
cn$percent_c <- (cn$c_ug*1000) / cn$weight_mg
cn %>%
ggplot(aes(x = expected_pH, y = percent_c, color = as.factor(expected_temp), fill = as.factor(expected_temp))) +
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(percent~C)
    )

percentcmodel <- lm(percent_c ~ expected_pH * expected_temp, data=cn)
anova(percentcmodel)
```

### % N
```{r, eval=FALSE, echo = FALSE}
cn$percent_n <- (cn$n_ug*1000) / cn$weight_mg
cn %>%
ggplot(aes(x = expected_pH, y = percent_n, color = as.factor(expected_temp), fill = as.factor(expected_temp))) +
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("skyblue2", "firebrick1")) +
  scale_color_manual(values = c("skyblue2", "firebrick1")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature (",degree,"C)")),
    fill = expression(paste("Temperature (",degree,"C)")),
    y = expression(percent~C)
    )

percentnmodel <- lm(percent_n ~ expected_pH * expected_temp, data=cn)
anova(percentnmodel)
```

# figs
```{r}
# standardized effect size response plots
rwrespoplot + rwgpplot + tegrespoplot + tegcalcplot + plot_layout(guides = "collect", axes = "collect")

# raw response plots
avgrwrespoplot <-
  avgrwrespoplot + 
  scale_x_continuous(breaks = c(7.2, 7.6, 8.0))+
  labs(y = expression(atop(Respiration~rate,(mu*mol~O[2]~g^-1~hr^-1))))

avggpplot <-
  avggpplot +
  scale_x_continuous(breaks = c(7.2, 7.6, 8.0))+
  labs(y = expression(atop(Gross~photosynthetic~rate,(mu*mol~O[2]~g^-1~hr^-1))))

avgtegrespoplot <-
  avgtegrespoplot +
  scale_x_continuous(breaks = c(7.2, 7.6, 8.0))+
  labs(y = expression(atop(Respiration~rate,(mu*mol~O[2]~g^-1~hr^-1))))

avgcalcplot <-
  avgcalcplot +
  scale_x_continuous(breaks = c(7.2, 7.6, 8.0))+
  labs(y = expression(atop(Calcification~rate,(mu*mol~CaCO[3]~g^-1~hr^-1))))

avgrwrespoplot + avggpplot + avgtegrespoplot + avgcalcplot + plot_layout(guides = "collect", axes = "collect_x")

ggsave("raw responses.png", path=here("Output"), width = 10, height = 8)
```
